<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SLP 92507 – Batch Voice Notes (Prototype)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --ink:#0f172a; --muted:#67728b; --line:#e7eaf0;
    --acc:#2f6bff; --acc2:#7fb3ff; --ok:#0a7c36; --err:#b00020;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;}
  .wrap{max-width:980px;margin:28px auto;padding:0 20px}
  h1{font-size:1.35rem;margin:0 0 6px;font-weight:680;letter-spacing:.2px}
  p.muted{color:var(--muted);margin:4px 0 18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;margin:14px 0;
        box-shadow:0 8px 20px rgba(15,23,42,.06)}
  label{font-weight:600;font-size:.95rem}
  input,select,textarea,button{
    border:1px solid var(--line);background:#fff;color:var(--ink);
    border-radius:12px;padding:12px;outline:none;font-size:15px
  }
  input::placeholder,textarea::placeholder{color:#97a0b3}
  textarea{width:100%;min-height:140px;resize:vertical}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
  button{cursor:pointer;background:linear-gradient(180deg,#fff,#f4f6fb);border:1px solid #cfd6e3}
  button.primary{border-color:#2f6bff;background:linear-gradient(180deg,#2f6bff,#184ed8);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .tiny{font-size:.86rem;color:var(--muted)}
  .subtle{font-size:.9rem;color:var(--muted)}
  /* Big Siri-like orb (double size) */
  .orb{width:110px;height:110px;border-radius:50%;
    background: radial-gradient(120% 120% at 30% 30%, #6aa5ff, #9ad0ff 35%, #7f8bff 60%, #b07dff 90%);
    box-shadow:0 0 40px rgba(106,165,255,.55), inset 0 0 26px rgba(255,255,255,.25);
    position:relative;margin:6px auto 10px;transform:translateZ(0)}
  .ring{position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(152,255,208,.25);filter:blur(.6px)}
  .orb.speaking{animation:pulseSpeak 1.4s ease-in-out infinite}
  .orb.listening{animation:pulseListen 1s ease-in-out infinite}
  @keyframes pulseSpeak{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  @keyframes pulseListen{0%{box-shadow:0 0 24px rgba(152,255,208,.45)}50%{box-shadow:0 0 48px rgba(152,255,208,.9)}100%{box-shadow:0 0 24px rgba(152,255,208,.45)}}
  .center{text-align:center}
  .stack{display:flex;flex-direction:column;gap:10px}
  /* Progress bar */
  .bar{height:10px;background:#eef2f8;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2f6bff,#7fb3ff);transition:width .25s ease;border-radius:999px}
  /* Notes list */
  .note{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <h1>SLP Daily Notes — Batch Voice Interview (Prototype)</h1>
  <p class="muted">Generates one-paragraph <b>92507</b> notes (no pain text). Voice prompts + auto-generate on “yes.” For <b>fake patients only</b>. No data saved.</p>

  <div class="card">
    <div class="grid">
      <label>OpenAI API Key
        <input id="apiKey" type="password" placeholder="sk-..." />
      </label>
      <label>Model
        <select id="model">
          <option value="gpt-4o-mini">gpt-4o-mini (recommended)</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
      </label>
      <label>Voice (device TTS)
        <select id="voiceSelect"><option>Loading voices…</option></select>
      </label>
      <label>Speech Rate
        <input id="rate" type="number" step="0.05" min="0.6" max="1.3" value="0.95" />
      </label>
    </div>
    <p class="tiny">Tip: run from <code>http://localhost</code> and allow the mic once so permission sticks.</p>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="stack">
        <div class="row">
          <button id="startBtn" class="primary">Start Interview</button>
          <button id="stopBtn" disabled>Stop</button>
          <span id="state" class="pill">idle</span>
        </div>
        <div class="row">
          <label>Minutes (per patient)
            <input id="minutes" type="number" min="1" max="120" placeholder="e.g., 25" style="width:130px">
          </label>
          <label>CPT
            <input id="cpt" type="text" value="92507" style="width:130px">
          </label>
          <label>How many notes?
            <input id="count" type="number" min="1" max="30" value="5" style="width:110px">
          </label>
        </div>
      </div>
      <div class="center" style="width:160px">
        <div class="orb" id="orb"><div class="ring"></div></div>
        <div id="orbLabel" class="tiny">ready</div>
      </div>
    </div>

    <div class="stack" style="margin-top:8px">
      <label>Optional preset text (appends to each patient’s bullets)</label>
      <textarea id="preset" placeholder="- Education: external memory aids
- Strategy: spaced retrieval
- Next: fade cues; generalize to ADLs"></textarea>
      <p class="subtle">You’ll speak one quick blob of bullets per patient (e.g., “STM 70% independent, 100% with mod cues; naming 50%→100% with max cues; staff ed on spaced retrieval”). If you omit <i>rationale</i> or <i>plan</i>, we insert smart defaults.</p>
    </div>

    <div class="stack" style="margin-top:6px">
      <div class="row" style="align-items:center; gap:16px">
        <div class="bar" style="flex:1"><span id="barFill"></span></div>
        <div class="tiny"><span id="pct">0%</span> • <span id="progress">0/0</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:10px">
        <button id="genBtn">Generate Current (manual)</button>
        <span id="aiStatus" class="pill">waiting</span>
      </div>
      <div class="tiny">Results appear below • tap Copy to paste into your EMR</div>
    </div>
    <div id="results" class="stack" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* -----------------------------
   Voice list (browser TTS)
----------------------------- */
const voiceSelect = document.getElementById('voiceSelect');
let VOICES = [];
function loadVoices(){
  VOICES = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  VOICES.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})${v.default?" — default":""}`;
    voiceSelect.appendChild(opt);
  });
  if(!VOICES.length){
    const opt=document.createElement('option');opt.textContent="No voices found";voiceSelect.appendChild(opt);
  }
}
if(typeof speechSynthesis!=='undefined'){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; }

/* -----------------------------
   UI refs
----------------------------- */
const stateEl = document.getElementById("state");
const orb = document.getElementById("orb");
const orbLabel = document.getElementById("orbLabel");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const minutesEl= document.getElementById("minutes");
const cptEl    = document.getElementById("cpt");
const countEl  = document.getElementById("count");
const presetEl = document.getElementById("preset");
const genBtn   =
